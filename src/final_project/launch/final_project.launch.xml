<?xml version="1.0" encoding="UTF-8"?>
<launch>
  <!-- Package paths -->
  <let name="pkg_share" value="$(find-pkg-share final_project)"/>
  <let name="xacro_file" value="$(var pkg_share)/urdf/turtlebot3_burger.xacro"/>
  <let name="robot_description" value="$(command 'xacro $(var xacro_file)')"/>
  
  <!-- Arguments -->
  <arg name="use_sim_time" default="true" />
  <arg name="world" default="$(var pkg_share)/worlds/maze_aruco_final.world" />
  <!-- <arg name="world" default="$(var pkg_share)/worlds/maze_world.world" /> -->
  <arg name="rviz_config" default="$(var pkg_share)/config/turtlebot3_config.rviz"/>
  <arg name="nav2_params" default="$(var pkg_share)/config/nav2_params.yaml"/>
  <arg name="slam_params" default="$(var pkg_share)/config/mapper_params_online_async.yaml"/>
  <arg name="map_file" default="$(var pkg_share)/maps/maze_map.yaml"/>
  <arg name="autostart" default="true"/>
  <arg name="use_slam" default="true"/>
  <arg name="spawn_x" default="0.25"/>
  <arg name="spawn_y" default="0.5"/>
  <arg name="spawn_z" default="0.0"/>
  <arg name="spawn_yaw" default="0.0"/>
  
  <!-- Robot State Publisher -->
  <node pkg="robot_state_publisher" exec="robot_state_publisher" output="screen">
    <param name="robot_description" type="str" value="$(var robot_description)"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>
  </node>
  
  <!-- Gazebo Setup -->
  <set_env name="GAZEBO_MODEL_PATH"
         value="$(var pkg_share)/models:$(env GAZEBO_MODEL_PATH)" />
  
  <set_env name="GAZEBO_RESOURCE_PATH"
         value="$(var pkg_share):$(env GAZEBO_RESOURCE_PATH)" />
  
  <executable cmd="gzserver --verbose $(var world) -s libgazebo_ros_init.so -s libgazebo_ros_factory.so" output="screen"/>
  <executable cmd="gzclient" output="screen"/>
  
  <!-- Spawn Robot -->
  <node pkg="gazebo_ros" exec="spawn_entity.py" output="screen" 
        args="-topic robot_description -entity turtlebot3_burger -x $(var spawn_x) -y $(var spawn_y) -z $(var spawn_z) -Y $(var spawn_yaw)" 
        launch-prefix="bash -c 'sleep 5; $0 $@'">
    <param name="use_sim_time" value="$(var use_sim_time)"/>
  </node>
  
  <!-- SLAM Toolbox (for mapping phase) -->
  <group if="$(var use_slam)">
    <node pkg="slam_toolbox" exec="async_slam_toolbox_node" name="slam_toolbox" output="screen">
      <param name="use_sim_time" value="$(var use_sim_time)"/>
      <remap from="scan" to="scan"/>
      <param from="$(var slam_params)"/>
    </node>
  </group>
  
  <!-- Map Server (for navigation phase with saved map) -->
  <group unless="$(var use_slam)">
    <node pkg="nav2_map_server" exec="map_server" name="map_server" output="screen">
      <param name="yaml_filename" value="$(var map_file)"/>
      <param name="use_sim_time" value="$(var use_sim_time)"/>
    </node>
    
    <node pkg="nav2_lifecycle_manager" exec="lifecycle_manager" name="lifecycle_manager_map" output="screen">
      <param name="use_sim_time" value="$(var use_sim_time)"/>
      <param name="autostart" value="$(var autostart)"/>
      <param name="node_names" value="['map_server']"/>
    </node>
  </group>
  
  <!-- Nav2 Navigation Stack -->
  <include file="$(find-pkg-share nav2_bringup)/launch/navigation_launch.py">
    <arg name="use_sim_time" value="$(var use_sim_time)"/>
    <arg name="params_file" value="$(var nav2_params)"/>
    <arg name="autostart" value="$(var autostart)"/>
  </include>
  
  <!-- RViz -->
  <node pkg="rviz2" exec="rviz2" output="screen" args="-d $(var rviz_config)">
    <param name="use_sim_time" value="$(var use_sim_time)"/>
  </node>
  
  <!-- Custom Perception Nodes -->
  <node pkg="final_project" exec="aruco_detector_node" name="aruco_detector_node" output="screen" launch-prefix="bash -c 'sleep 10; $0 $@'">
    <param name="use_sim_time" value="$(var use_sim_time)"/>
    <param name="camera_topic" value="/camera/image_raw"/>
    <param name="camera_info_topic" value="/camera/camera_info"/>
    <param name="aruco_dictionary" value="DICT_4X4_50"/>
    <param name="marker_size" value="0.1"/>
  </node>
  
  <node pkg="final_project" exec="shape_detector_node" name="shape_detector_node" output="screen" launch-prefix="bash -c 'sleep 10; $0 $@'">
    <param name="use_sim_time" value="$(var use_sim_time)"/>
    <param name="camera_topic" value="/camera/image_raw"/>
  </node>
  
  <node pkg="final_project" exec="color_detector_node" name="color_detector_node" output="screen" launch-prefix="bash -c 'sleep 10; $0 $@'">
    <param name="use_sim_time" value="$(var use_sim_time)"/>
    <param name="camera_topic" value="/camera/image_raw"/>
  </node>
  
  <!-- Custom Control Nodes -->
  <node pkg="final_project" exec="exploration_manager_node" name="exploration_manager_node" output="screen" launch-prefix="bash -c 'sleep 15; $0 $@'">
    <param name="use_sim_time" value="$(var use_sim_time)"/>
    <param name="cell_size" value="0.5"/>
    <param name="grid_width" value="8"/>
    <param name="grid_height" value="8"/>
  </node>
  
  <node pkg="final_project" exec="navigation_controller_node" name="navigation_controller_node" output="screen" launch-prefix="bash -c 'sleep 15; $0 $@'">
    <param name="use_sim_time" value="$(var use_sim_time)"/>
  </node>
  
</launch>